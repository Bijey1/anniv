<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Save Me ‚ù§Ô∏è</title>

    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        overflow: hidden;
        background: #87ceeb;
      }

      /* INTRO GIF */
      #intro-gif {
        position: fixed;
        inset: 0;
        background: black;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
      }

      #intro-gif img {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
      }

      /* GAME */
      #game {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      /* PLAYER */
      .player {
        position: absolute;
        top: 100px;
        right: 70px;
        width: 50px;
        height: 50px;
        z-index: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
      }
      #cage {
        position: absolute;
        top: 101px;
        right: 70px;
        width: 50px;
        height: 50px;
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
      }

      /* SQUARE OBJECTS */
      .enemy {
        position: absolute;
        width: 50px;
        height: 50px;
        z-index: 1;
      }
      .boss {
        position: absolute;
        width: 50px;
        z-index: 2;
        height: 50px;
      }

      .lock {
        width: 80px;
        height: 80px;
        background: brown;
      }

      .door {
        width: 200px;
        height: 200px;
      }

      /* OVERLAY */
      #overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        text-align: center;
        z-index: 500;
      }

      button {
        margin-top: 15px;
        padding: 10px 20px;
        font-size: 18px;
        border-radius: 10px;
        border: none;
        background: #ff6347;
        color: white;
      }

      #boss-hp {
        position: absolute;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 70%;
        height: 16px;
        border: 2px solid black;
        background: #444;
        display: none; /* only show during boss */
      }

      #boss-hp-fill {
        height: 100%;
        width: 100%;
        background: red;
        transition: width 0.2s;
      }
      @keyframes shake {
        0% {
          transform: translateX(0);
        }
        20% {
          transform: translateX(-10px);
        }
        40% {
          transform: translateX(10px);
        }
        60% {
          transform: translateX(-10px);
        }
        80% {
          transform: translateX(10px);
        }
        100% {
          transform: translateX(0);
        }
      }

      .shake {
        animation: shake 0.3s ease;
      }

      @keyframes shakeB {
        0% {
          transform: translateX(0);
        }
        5% {
          transform: translateX(-30px);
        }
        10% {
          transform: translateX(30px);
        }
        15% {
          transform: translateX(-30px);
        }
        20% {
          transform: translateX(30px);
        }
        25% {
          transform: translateX(-30px);
        }
        30% {
          transform: translateX(30px);
        }
        35% {
          transform: translateX(-30px);
        }
        40% {
          transform: translateX(30px);
        }
        45% {
          transform: translateX(-30px);
        }
        50% {
          transform: translateX(30px);
        }
        55% {
          transform: translateX(-30px);
        }
        60% {
          transform: translateX(30px);
        }
        65% {
          transform: translateX(-30px);
        }
        70% {
          transform: translateX(30px);
        }
        75% {
          transform: translateX(-30px);
        }
        80% {
          transform: translateX(30px);
        }
        85% {
          transform: translateX(-30px);
        }
        90% {
          transform: translateX(30px);
        }
        95% {
          transform: translateX(-30px);
        }
        100% {
          transform: translateX(0);
        }
      }

      .shakeBos {
        animation: shakeB 1s ease;
      }

      #wave-screen {
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;

        background: rgba(0, 0, 0, 0.85);
        z-index: 999;

        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
      }

      #wave-text {
        padding: 20px;
        color: white;
        font-weight: bold;
        text-align: center;

        /* Dynamic sizing */
        font-size: clamp(32px, 8vw, 72px);
        letter-spacing: 0.2em;

        /* Smooth animation */
        transform: scale(0.8);
        transition: transform 0.5s ease;
      }

      #wave-screen.show {
        opacity: 1;
      }

      #wave-screen.show #wave-text {
        transform: scale(1);
      }

      #speech {
        position: absolute;
        top: 10px;
        right: 70px;
        background: white;
        color: black;
        padding: 5px 20px;
        border-radius: 10px;
        font-size: 20px;
        min-width: 100px;
        max-width: 170px;
      }
      .enemy-speech {
        position: absolute;
        top: 10px;
        right: 70px;
        background: white;
        color: black;
        padding: 3px 15px;
        font-weight: bold;
        border-radius: 10px;
        font-size: 20px;
        min-width: 10px;
        max-width: 170px;
      }

      .vs-card {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle, #000 30%, #000c 100%);
        display: flex;
        align-items: center;
        justify-content: space-between;
        z-index: 9999;
        padding: 5vw;
        box-sizing: border-box;
      }

      .vs-side {
        width: 35vw;
        max-width: 180px;
        min-width: 90px;
      }

      .vs-side img {
        width: 100%;
        height: auto;
        object-fit: contain;
      }

      .vs-text {
        font-size: clamp(48px, 15vw, 120px);
        font-weight: 900;
        color: red;
        text-shadow: 0 0 12px black;
      }

      .vs-card.hide {
        animation: vsFadeOut 0.3s ease forwards;
      }

      @keyframes vsFadeOut {
        to {
          opacity: 0;
          transform: scale(1.05);
        }
      }

      .vs-side.left {
        animation: slideLeft 0.4s ease;
      }
      .vs-side.right {
        animation: slideRight 0.4s ease;
      }

      @keyframes slideLeft {
        from {
          transform: translateX(-30vw);
          opacity: 0;
        }
      }
      @keyframes slideRight {
        from {
          transform: translateX(30vw);
          opacity: 0;
        }
      }

      .vs-hint {
        position: absolute;
        bottom: 6vh;
        left: 50%;
        transform: translateX(-50%);
        font-size: clamp(14px, 4vw, 20px);
        color: #fff;
        opacity: 0.8;
        letter-spacing: 1px;
        text-shadow: 0 0 6px black;
        animation: pulseHint 1.4s infinite;
        pointer-events: none;
      }

      @keyframes pulseHint {
        0% {
          opacity: 0.4;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.4;
        }
      }

      .vs-name {
        margin-top: 3vh;
        font-size: clamp(12px, 3.5vw, 18px);
        font-weight: 600;
        color: #fff;
        text-shadow: 0 0 6px black;
        letter-spacing: 1px;
        text-align: center;
      }
      @keyframes shakeB {
        0% {
          transform: translate(0, 0) rotate(0deg);
        }
        10% {
          transform: translate(-5px, 0) rotate(-5deg);
        }
        20% {
          transform: translate(5px, 0) rotate(5deg);
        }
        30% {
          transform: translate(-5px, 0) rotate(-5deg);
        }
        40% {
          transform: translate(5px, 0) rotate(5deg);
        }
        50% {
          transform: translate(-5px, 0) rotate(-5deg);
        }
        60% {
          transform: translate(5px, 0) rotate(5deg);
        }
        70% {
          transform: translate(-5px, 0) rotate(-5deg);
        }
        80% {
          transform: translate(5px, 0) rotate(5deg);
        }
        90% {
          transform: translate(-5px, 0) rotate(-5deg);
        }
        100% {
          transform: translate(0, 0) rotate(0deg);
        }
      }

      /* kick animation */
      .kicked {
        animation: kickOut 2s linear forwards;
      }

      @keyframes kickOut {
        from {
          transform: translate(0, 0) rotate(0deg) scale(1);
          opacity: 1;
        }

        to {
          transform: translate(150vw, -150vh) rotate(3600deg) scale(0.5);
          opacity: 0;
        }
      }

      /* animation triggered by adding class */

      .fall {
        animation: fallDown 3s linear forwards;
      }

      @keyframes fallDown {
        0% {
          top: 40px;
        }
        100% {
          top: 515px;
        }
      }
    </style>
  </head>

  <body>
    <!-- INTRO CUTSCENE 
    <div id="intro-gif">
      <img src="boss-kidnap.gif" alt="Boss kidnaps me" />
    </div>
-->
    <!-- GAME -->
    <div id="game">
      <div id="boss-hp">
        <div id="boss-hp-fill"></div>
      </div>
      <div id="cage">
        <img src="assets/emptyCage.png" />
      </div>

      <div class="player">
        <img src="assets/bigSad.png" />
        <div id="speech">Help me!</div>
      </div>
    </div>

    <!-- MESSAGE -->
    <div id="overlay">
      <div id="overlay-text"></div>
      <button id="next">Next</button>
    </div>

    <script>
      let wave = 1;
      let waveIntroShown = false;
      const game = document.getElementById("game");
      const overlay = document.getElementById("overlay");
      const overlayText = document.getElementById("overlay-text");
      const nextBtn = document.getElementById("next");
      const speech = document.getElementById("speech");
      const player = document.querySelector(".player");
      const cage = document.getElementById("cage");
      const cageImg = document.querySelector("#cage img");

      let level = 1;
      let objects = [];
      let lost = false;

      //////////////// INTRO //////////////////
      /*
      setTimeout(() => {
        document.getElementById("intro-gif").style.display = "none";
        startLevel();
      }, 3000); // match GIF length
      */
      //document.getElementById("intro-gif").style.display = "none";
      startLevel();

      //////////////// GAME CORE //////////////////
      function clearGame() {
        objects.forEach((o) => o.remove());
        objects = [];
      }

      function showOverlay(text) {
        overlayText.innerText = text;
        overlay.style.display = "flex";
      }
      const rivalSpeech = new Audio();
      const rivalBg = new Audio();
      const lostSfx = new Audio();
      const damage = new Audio();
      rivalSpeech.src = "assets/rival.mp3";
      rivalBg.src = "assets/bone.mp3";
      lostSfx.src = "assets/lost.mp3";
      damage.src = "assets/damage.mp3";
      nextBtn.onclick = () => {
        overlay.style.display = "none";
        waveIntroShown = false;
        if (lost) {
          if (level == 4) {
            rivalSpeech.play();
            level = 4;

            startLevel();
          } else {
            level = 1;
            wave = 1;
            waveIntroShown = false;
          }
        } else {
          level++;
          if (level == 4) {
            rivalSpeech.play();
          }
        }
        startLevel();
      };

      //////////////// LEVELS //////////////////
      let again1 = true;

      function startLevel() {
        clearGame();

        if (level === 1) {
          level1(9);
        } else if (level === 2) {
          console.log("nag run");
          level2();
        } else if (level === 3) {
          level3();
          //tempo();
        } else if (level === 4) level4();
        else endGame();
      }

      function tempo() {
        level = 3;
        showOverlay("Tempo lang to");
      }

      function showWaveScreen(whatText, waveNumber, callback) {
        const screen = document.createElement("div");
        screen.id = "wave-screen";

        const text = document.createElement("div");
        text.id = "wave-text";
        text.innerText = `${whatText} ${waveNumber}`;

        screen.appendChild(text);
        document.body.appendChild(screen);

        // Fade in
        setTimeout(() => screen.classList.add("show"), 50);

        // Hold ‚Üí fade out ‚Üí then start next wave
        setTimeout(() => {
          screen.classList.remove("show");

          setTimeout(() => {
            screen.remove();
            callback(); // start next wave AFTER transition
          }, 300);
        }, 1900);
      }

      /* LEVEL 1 ‚Äì Tap Enemies */
      function level1(enemyCnt) {
        speech.innerText = "Tap them before they reach the bottom!";

        if (!waveIntroShown) {
          waveIntroShown = true;

          showWaveScreen("WAVE", wave, () => {
            level1(enemyCnt); // restart level after intro
          });

          return; // stop execution for now
        }
        // Add tap effect listeners
        function spawnTapEffect(x, y) {
          const effect = document.createElement("img");
          effect.src = "assets/sword_cut.gif";
          effect.style.position = "fixed";
          effect.style.left = x - 25 + "px";
          effect.style.top = y - 25 + "px";
          effect.style.width = "50px";
          effect.style.height = "50px";
          effect.style.pointerEvents = "none";
          effect.style.zIndex = 999;

          document.body.appendChild(effect);

          setTimeout(() => effect.remove(), 250);
        }

        function clickListener(e) {
          spawnTapEffect(e.clientX, e.clientY);
        }

        function touchListener(e) {
          const touch = e.touches[0];
          spawnTapEffect(touch.clientX, touch.clientY);
        }

        document.addEventListener("click", clickListener);
        document.addEventListener("touchstart", touchListener);

        // When level ends, remove listeners
        function cleanupTapEffect() {
          document.removeEventListener("click", clickListener);
          document.removeEventListener("touchstart", touchListener);
        }

        // Call cleanup whenever level ends
        const originalShowOverlay = showOverlay;
        showOverlay = (text) => {
          cleanupTapEffect();
          originalShowOverlay(text);
        };
        setTimeout(() => {
          speech.innerText = "";
          speech.style.background = "none";
        }, 3000); //Delay

        let gameOver = false;
        const loseLine = 95; // vh
        const enemyCount = enemyCnt;

        // Create horizontal lanes
        const laneWidth = 80 / enemyCount; // vw (safe area)

        for (let i = 0; i < enemyCount; i++) {
          const e = document.createElement("div");
          e.className = "enemy";

          const img = document.createElement("img");
          img.src = "assets/goons.gif";
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.pointerEvents = "none"; // important!

          e.appendChild(img);

          // Spawn near top, not on player
          let y = 20 + Math.random() * 10; // 20‚Äì30vh

          // Lane-based X position
          let x = i * laneWidth + laneWidth / 2;

          e.style.top = y + "vh";
          e.style.left = x + "vw";

          game.appendChild(e);
          objects.push(e);

          // Slow downward movement
          const speed = 0.1 + Math.random() * 0.15;

          const moveInterval = setInterval(() => {
            if (gameOver) {
              clearInterval(moveInterval);
              return;
            }

            y += speed;
            e.style.top = y + "vh";

            if (y >= loseLine) {
              gameOver = true;
              clearInterval(moveInterval);
              showOverlay("Oh no! They got past you üíî");
              lost = true;
            }
          }, 20);

          // Tap to destroy
          e.onclick = () => {
            clearInterval(moveInterval);
            e.remove();
            objects = objects.filter((o) => o !== e);

            if (!objects.length && !gameOver) {
              cleanupTapEffect();

              if (wave === 3) {
                showOverlay("Nice! Keep going!");
              } else {
                const nextEnemyCount = wave === 1 ? 19 : wave === 2 ? 30 : 0;

                const nextWave = wave + 1;

                showWaveScreen("WAVE", nextWave, () => {
                  level1(nextEnemyCount);
                });
              }

              wave++;
            }
          };
        }
      }

      /* LEVEL 2 ‚Äì Tap Barrier */
      function level2() {
        speech.innerText = "I think the password is the date we first met";

        if (!waveIntroShown) {
          waveIntroShown = true;
          showWaveScreen("Put the Correct Password to Pass", "", () => {});
        }

        let input = "";
        let unlocked = false;
        let taps = 0;

        const correctCode = "0215";

        // ====== DOOR ======
        const wall = document.createElement("div");
        wall.className = "enemy door";
        wall.style.top = "35vh";
        wall.style.left = "15vw";

        const doorImg = document.createElement("img");
        doorImg.src = "assets/doorPassRes.png";
        doorImg.style.pointerEvents = "none";
        wall.appendChild(doorImg);

        game.appendChild(wall);
        objects.push(wall);

        // ====== KEYPAD BUTTON (ON DOOR) ======
        const keypadBtn = document.createElement("div");
        keypadBtn.style.width = "20vw";
        keypadBtn.style.height = "10vh";
        keypadBtn.style.position = "absolute";
        keypadBtn.style.bottom = "-20%";
        keypadBtn.style.left = "50%";
        keypadBtn.style.transform = "translateX(-50%)";
        keypadBtn.style.cursor = "pointer";

        wall.appendChild(keypadBtn);

        // ====== OVERLAY ======
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(0,0,0,0.8)";
        overlay.style.display = "none";
        overlay.style.alignItems = "center";
        overlay.style.justifyContent = "center";
        overlay.style.zIndex = "1000";

        overlay.onclick = () => {
          overlay.style.display = "none";
        };

        // ====== KEYPAD PANEL ======
        const panel = document.createElement("div");
        panel.style.background = "#111";
        panel.style.padding = "20px";
        panel.style.borderRadius = "16px";
        panel.style.width = "260px";
        panel.style.textAlign = "center";

        panel.onclick = (e) => e.stopPropagation();

        // ====== DISPLAY ======
        const display = document.createElement("div");
        display.style.background = "black";
        display.style.color = "lime";
        display.style.fontSize = "28px";
        display.style.padding = "10px";
        display.style.marginBottom = "12px";
        display.style.letterSpacing = "4px";
        display.innerText = "____";

        panel.appendChild(display);

        // ====== KEYS ======
        const keys = document.createElement("div");
        keys.style.display = "grid";
        keys.style.gridTemplateColumns = "repeat(3, 1fr)";
        keys.style.gap = "10px";

        const buttons = [
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
          "C",
          "0",
          "OK",
        ];

        buttons.forEach((label) => {
          const btn = document.createElement("button");
          btn.innerText = label;
          btn.style.fontSize = "20px";
          btn.style.padding = "15px";
          btn.style.borderRadius = "10px";

          btn.onclick = () => {
            if (label === "C") {
              input = "";
            } else if (label === "OK") {
              if (input === correctCode) {
                unlocked = true;
                overlay.style.display = "none";
                keypadBtn.remove();
                doorImg.src = "assets/door.png";
                speech.innerText = "You remembered‚Ä¶ üíñ Break the door!";
              } else {
                panel.classList.add("shake");
                setTimeout(() => panel.classList.remove("shake"), 300);
                input = "";
              }
            } else {
              if (input.length < 4) input += label;
            }

            display.innerText = input.padEnd(4, "_");
          };

          keys.appendChild(btn);
        });

        panel.appendChild(keys);
        overlay.appendChild(panel);
        document.body.appendChild(overlay);

        keypadBtn.onclick = () => {
          overlay.style.display = "flex";
        };

        // ====== BREAK DOOR ======
        wall.onclick = () => {
          if (!unlocked) return;

          wall.style.transform = "translateX(-20px)";
          setTimeout(() => (wall.style.transform = "none"), 100);
          taps++;

          if (taps === 3) doorImg.src = "assets/2door.png";
          if (taps === 6) doorImg.src = "assets/finalDoor.png";

          if (taps >= 8) {
            wall.remove();
            showOverlay("You broke it!");
          }
        };
      }

      /* LEVEL 3 ‚Äì Find the Correct Key */

      function level3() {
        speech.innerText = "Find the Correct Key, Bebe!";
        if (!waveIntroShown) {
          waveIntroShown = true;

          showWaveScreen("Find the Correct Key to Open the Door", "", () => {});
        }

        player.style.top = "100px";
        //hello
        const keyCount = 20;
        const correct = Math.floor(Math.random() * keyCount);

        // TIMER BAR SETTINGS
        let timeLeft = 15; // seconds
        const timerBar = document.createElement("div");
        timerBar.id = "level3-timer-bar";
        timerBar.style.position = "absolute";
        timerBar.style.top = "5vh";
        timerBar.style.left = "5vw";
        timerBar.style.width = "80vw";
        timerBar.style.height = "20px";
        timerBar.style.backgroundColor = "#555";
        timerBar.style.border = "2px solid #fff";
        timerBar.style.borderRadius = "10px";
        timerBar.style.overflow = "hidden";
        timerBar.style.zIndex = 1000;

        const timerFill = document.createElement("div");
        timerFill.style.height = "100%";
        timerFill.style.width = "100%";
        timerFill.style.backgroundColor = "#4caf50"; // green bar
        timerFill.style.transition = "width 0.2s linear";

        timerBar.appendChild(timerFill);
        game.appendChild(timerBar);

        const timerInterval = setInterval(() => {
          timeLeft -= 0.1; // 0.1 sec step for smooth shrinking
          if (timeLeft < 0) timeLeft = 0;

          const percent = (timeLeft / 20) * 100;
          timerFill.style.width = percent + "%";

          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerBar.remove();
            showOverlay("Time's up! ‚è∞");
            objects.forEach((o) => o.remove());
            objects = [];
          }
        }, 100);

        // Door position
        const lockX = 15;
        const lockY = 35;
        const doorSafeRadius = 40;

        // Player/top safe zone
        const topSafeY = 25; // vh

        // Prevent overlap
        const usedPositions = [];
        const keySafeRadius = 8;

        const lock = document.createElement("div");
        lock.className = "enemy door";
        lock.style.top = lockY + "vh";
        lock.style.left = lockX + "vw";

        const img = document.createElement("img");
        img.src = "assets/keyDoor.png";

        img.style.pointerEvents = "none";
        lock.appendChild(img);

        game.appendChild(lock);
        objects.push(lock);

        for (let i = 0; i < keyCount; i++) {
          const key = document.createElement("div");
          key.className = "enemy";

          const img2 = document.createElement("img");
          img2.src = "assets/key.png";
          img2.style.pointerEvents = "none";
          key.appendChild(img2);

          let x, y;
          let valid = false;

          while (!valid) {
            x = Math.random() * 80;
            y = Math.random() * 80;
            valid = true;

            if (y < topSafeY) valid = false; // avoid player
          }

          usedPositions.push({ x, y });

          key.style.left = x + "vw";
          key.style.top = y + "vh";

          key.onclick = () => {
            if (i === correct) {
              clearInterval(timerInterval);
              timerBar.remove();
              showOverlay("It worked!");
            } else {
              key.classList.add("shake");
              setTimeout(() => key.classList.remove("shake"), 300);
            }
          };

          game.appendChild(key);
          objects.push(key);
        }
      }

      loop = 0;
      /* LEVEL 4 ‚Äì Boss */
      /* LEVEL 4 ‚Äì Boss with minions */
      function level4() {
        let gameOver4 = false;

        lost = false;
        speech.innerText = "Finish him!";
        player.style.top = "100px";

        const hpBar = document.getElementById("boss-hp");
        const hpFill = document.getElementById("boss-hp-fill");
        hpBar.style.display = "none";
        hpFill.style.width = "100%";

        // ====== Litus moving in from bottom ======
        const litus = document.createElement("div");
        litus.className = "enemy";
        litus.style.width = "60px";
        litus.style.height = "60px";

        let y = 110; // start below screen
        const x = 45; // vw

        litus.style.left = x + "vw";
        litus.style.top = y + "vh";

        const litusImg = document.createElement("img");
        litusImg.src = "assets/backWalk.gif";
        litusImg.style.pointerEvents = "none";
        litus.appendChild(litusImg);

        game.appendChild(litus);
        objects.push(litus);

        const speed = 0.25; // moving speed

        let maxHP = 60;
        let hp = maxHP;

        //hp = 5;

        // ====== BOSS ======
        const boss = document.createElement("div");
        boss.className = "boss";
        boss.style.width = "300px";
        boss.style.height = "300px";
        boss.style.top = "30vh";
        boss.style.left = "15vw";

        const jongImg = document.createElement("img");
        jongImg.src = "assets/jongSt.png";
        jongImg.style.pointerEvents = "none";
        jongImg.style.width = "100%";
        jongImg.style.height = "100%";
        boss.appendChild(jongImg);

        game.appendChild(boss);
        objects.push(boss);
        const audio = new Audio();

        // Play music A
        audio.src = "assets/rawrSlowed.mp3";

        // ====== Litus move interval ======
        const walkInterval = setInterval(() => {
          y -= speed;
          litus.style.top = y + "vh";

          if (y <= 85) {
            clearInterval(walkInterval);
            litusImg.src = "assets/backLitus.png";

            // ====== Boss speech ======
            enemySpeechLikeSpeech(
              boss,
              [
                "So.. you finally arrived",
                "Time to face your fate",
                "Let's see how strong you really are",
              ],
              () => {
                rivalSpeech.pause();
                rivalSpeech.currentTime = 0;
                // AFTER DIALOG FINISHES

                jongImg.src = "assets/jongBig.gif";
                setTimeout(() => {
                  audio.play(); //Rawr
                }, 3500);

                setTimeout(() => {
                  enemySpeechLikeSpeech(boss, ["MWAHA!!"], () => {
                    audio.pause(); //Rawr
                    audio.currentTime = 0;
                    litus.remove();
                    rivalBg.play();
                    showVsCard(
                      "assets/bigLitus.png",
                      "Litus",
                      "assets/jong.png",
                      "Jeonghan",
                      () => {
                        // start boss fight AFTER VS screen
                        jongImg.src = "assets/jongIdle.gif";
                        hpBar.style.display = "block";
                        function spawnTapEffect(x, y) {
                          const effect = document.createElement("img");
                          effect.src = "assets/sword_cut.gif";
                          effect.style.position = "fixed";
                          effect.style.left = x - 25 + "px";
                          effect.style.top = y - 25 + "px";
                          effect.style.width = "50px";
                          effect.style.height = "50px";
                          effect.style.pointerEvents = "none";
                          effect.style.zIndex = 999;

                          document.body.appendChild(effect);

                          setTimeout(() => effect.remove(), 250);
                        }

                        function clickListener(e) {
                          spawnTapEffect(e.clientX, e.clientY);
                        }

                        function touchListener(e) {
                          const touch = e.touches[0];
                          spawnTapEffect(touch.clientX, touch.clientY);
                        }

                        document.addEventListener("click", clickListener);
                        document.addEventListener("touchstart", touchListener);

                        // When level ends, remove listeners
                        function cleanupTapEffect() {
                          document.removeEventListener("click", clickListener);
                          document.removeEventListener(
                            "touchstart",
                            touchListener
                          );
                        }

                        // ====== Boss tapping ======
                        boss.onclick = () => {
                          damage.play();
                          boss.classList.add("shake");
                          setTimeout(() => {
                            boss.classList.remove("shake");
                            damage.pause();
                            damage.currentTime = 0;
                          }, 200);
                          hp--;
                          hpFill.style.width = (hp / maxHP) * 100 + "%";

                          if (hp <= 0) {
                            cleanupTapEffect();
                            //Beaten won , boss defeated
                            //boss.remove();
                            //hpBar.style.display = "none";
                            if (gameOver4) return; //  prevents repeat execution
                            gameOver4 = true;
                            rivalBg.pause();
                            speech.style.display = "none";
                            jongImg.src = "assets/damagedJong.png";
                            rivalBg.currentTime = 0;
                            minionInterval && clearInterval(minionInterval);
                            objects
                              .filter((o) => o.classList.contains("enemy"))
                              .forEach((o) => o.remove());

                            boss.style.pointerEvents = "none";
                            boss.classList.add("shake");
                            setTimeout(() => {
                              boss.classList.remove("shake");
                            }, 200);
                            setTimeout(() => {
                              boss.classList.add("shake");
                            }, 300);

                            // ====== Litus moving in from bottom ======
                            const litus2 = document.createElement("div");
                            litus2.className = "enemy";
                            litus2.style.width = "60px";
                            litus2.style.height = "60px";

                            let y2 = 55; // up down
                            let x2 = -20; // vw

                            litus2.style.left = x2 + "vw";
                            litus2.style.top = y2 + "vh";

                            const litus2Img = document.createElement("img");
                            litus2Img.src = "assets/sideWalk.gif";
                            litus2Img.style.pointerEvents = "none";
                            litus2.appendChild(litus2Img);

                            game.appendChild(litus2);
                            objects.push(litus2);

                            const speed2 = 0.2; // moving speed

                            // Remove shakeBos class after animation ends

                            setTimeout(() => {
                              jongImg.src = "assets/damagedJong.gif";
                              setTimeout(() => {
                                // After shrinking ni boss
                                // ====== Litus move interval ======
                                const walkInterval2 = setInterval(() => {
                                  x2 += speed2;
                                  litus2.style.left = x2 + "vh";

                                  if (x2 >= 10) {
                                    clearInterval(walkInterval2);
                                    litus2Img.src = "assets/bigLitus.png"; //Litus Walk

                                    //After makarating ni litus
                                    enemySpeechLikeSpeech(
                                      boss,
                                      [
                                        "Agay! Yawa!",
                                        "Sorry na, Sayo na tong bebe mo",
                                        "Auko na Pls",
                                        "Pazinsya na",
                                      ],
                                      () => {
                                        enemySpeechLikeSpeech(
                                          boss,
                                          ["Nah", "Pakyu Jong Han"],
                                          () => {
                                            litus2Img.src =
                                              "assets/sideWalk.gif"; //Litus Walk
                                            const walkInterval3 = setInterval(
                                              () => {
                                                x2 += speed2;
                                                litus2.style.left = x2 + "vh";

                                                if (x2 >= 14) {
                                                  clearInterval(walkInterval3);
                                                  litus2Img.src =
                                                    "assets/litusPunch.gif"; //Litus Walk

                                                  setTimeout(() => {
                                                    boss.classList.add(
                                                      "kicked"
                                                    );

                                                    // remove bossacter after animation
                                                    boss.addEventListener(
                                                      "animationend",
                                                      () => {
                                                        boss.remove();
                                                        hpBar.style.display =
                                                          "none";

                                                        //Speech sa cage
                                                        speech.style.display =
                                                          "block";
                                                        speech.innerText =
                                                          "YEHEY!!";
                                                        setTimeout(() => {
                                                          speech.innerText =
                                                            "Thank you Bebe!!";

                                                          setTimeout(() => {
                                                            let clicks = 0;
                                                            speech.innerText =
                                                              "Tap the cage to free me bebe!";

                                                            cage.style.pointerEvents =
                                                              "auto";
                                                            cage.onclick =
                                                              () => {
                                                                clicks++;
                                                                cage.classList.add(
                                                                  "shake"
                                                                );
                                                                setTimeout(
                                                                  () =>
                                                                    cage.classList.remove(
                                                                      "shake"
                                                                    ),
                                                                  300
                                                                );

                                                                if (
                                                                  clicks == 4
                                                                ) {
                                                                  cageImg.src =
                                                                    "assets/damagedCage.png";
                                                                } else if (
                                                                  clicks == 8
                                                                ) {
                                                                  speech.style.display =
                                                                    "none";
                                                                  cageImg.src =
                                                                    "assets/destroyedCage.png";
                                                                  player.classList.add(
                                                                    "fall"
                                                                  );

                                                                  setTimeout(
                                                                    () =>
                                                                      //Player fall from cage
                                                                      1500
                                                                  );
                                                                }
                                                              };
                                                          }, 2000);
                                                        }, 2000);
                                                      },
                                                      { once: true }
                                                    );
                                                  }, 1450);
                                                }
                                              },
                                              20
                                            );
                                          },

                                          -300, //x
                                          90, //y
                                          "no"
                                        );
                                      },
                                      -220, //x
                                      90, //y
                                      "no"
                                    );
                                  }
                                }, 20);
                              }, 2500);
                            }, 1800);

                            //Speech after defeated

                            //clearGame();

                            //showOverlay("You saved me ‚ù§Ô∏è");
                          }
                        };

                        // ====== Minion spawner ======
                        const loseLine = 95; // vh
                        const minionSpeed = 0.4;
                        // const minionSpeed = 0.1;

                        // boss horizontal safe zone
                        const bossLeft = 15; // vw
                        const bossWidth = 25; // vw
                        const minX1 = 0;
                        const maxX1 = bossLeft; // left side of boss
                        const minX2 = bossLeft + bossWidth; // right side of boss
                        const maxX2 = 80; // right screen edge

                        const minionInterval = setInterval(() => {
                          const minion = document.createElement("div");
                          minion.className = "enemy";

                          const img = document.createElement("img");
                          img.src = "assets/goons.gif";
                          img.style.pointerEvents = "none";
                          minion.appendChild(img);

                          // spawn at random horizontal position outside boss
                          let xPos;
                          if (Math.random() < 0.5) {
                            // left side
                            xPos = minX1 + Math.random() * (maxX1 - minX1);
                          } else {
                            // right side
                            xPos = minX2 + Math.random() * (maxX2 - minX2);
                          }

                          let yPos = -10; // start above screen
                          minion.style.left = xPos + "vw";
                          minion.style.top = yPos + "vh";

                          game.appendChild(minion);
                          objects.push(minion);

                          // move minion downward
                          const moveInterval = setInterval(() => {
                            yPos += minionSpeed;
                            minion.style.top = yPos + "vh";
                            if (yPos >= loseLine) {
                              if (gameOver4) return; // üö® prevents repeat execution
                              gameOver4 = true;
                              rivalBg.pause();
                              rivalBg.currentTime = 0;
                              lostSfx.play();

                              console.log("LOST SA 4");

                              clearInterval(minionInterval);
                              clearInterval(moveInterval);

                              // remove ALL minions
                              objects
                                .filter((o) => o.classList.contains("enemy"))
                                .forEach((o) => o.remove());

                              clearGame();

                              objects = [];

                              lost = true;

                              showOverlay("Oh no! Minions got past you üíî");
                            }
                          }, 20);

                          // Tap to destroy
                          minion.onclick = () => {
                            clearInterval(moveInterval);
                            minion.remove();
                            objects = objects.filter((o) => o !== minion);
                          };
                        }, 1000); // spawn every 3 sec
                      },
                      50,
                      -100,
                      "big"
                    );
                  });
                }, 6900); // Last speech before final battle
              },
              -220,
              70,
              "no"
            );

            speech.innerText = "It's here!";
          }
        }, 20);
      }

      function showVsCard(
        playerImgSrc,
        playerName,
        bossImgSrc,
        bossName,
        onFinish
      ) {
        const vs = document.createElement("div");
        vs.className = "vs-card";

        vs.innerHTML = `
    <div class="vs-side left">
      <img src="${playerImgSrc}">
      <div class="vs-name">${playerName}</div>
    </div>

    <div class="vs-text">VS</div>

    <div class="vs-side right">
      <img src="${bossImgSrc}">
      <div class="vs-name">${bossName}</div>
    </div>

    <div class="vs-hint">Tap anywhere to begin</div>
  `;

        document.body.appendChild(vs);

        vs.addEventListener("click", () => {
          vs.classList.add("hide");
          setTimeout(() => {
            vs.remove();
            onFinish && onFinish();
          }, 300);
        });
      }

      /* END */
      function endGame() {
        speech.innerText = "I'm free!";
        overlay.style.display = "flex";
        overlayText.innerText =
          "Happy Anniversary ‚ù§Ô∏è\nThank you for saving me!";
        nextBtn.style.display = "none";
      }

      function enemySpeechLikeSpeech(
        enemy,
        lines,
        onFinish,
        offsetX = 0,
        offsetY = 0,
        big
      ) {
        let index = 0;

        const bubble = document.createElement("div");
        bubble.className = "enemy-speech";

        function update() {
          bubble.innerText = lines[index];
          const rect = enemy.getBoundingClientRect();

          if (big == "no") {
            bubble.style.top = rect.top + rect.height / 4 + offsetY + "px";
            bubble.style.left = rect.right + offsetX + "px";
          } else {
            bubble.style.top = rect.top + offsetY + "px";
            bubble.style.right = offsetX + "px";
          }
        }

        update();
        document.body.appendChild(bubble);

        function advanceDialog() {
          index++;
          if (index >= lines.length) {
            bubble.remove();
            document.removeEventListener("click", advanceDialog); // remove listener
            if (onFinish) onFinish();
          } else {
            update();
          }
        }

        // Anywhere tap advances dialog
        document.addEventListener("click", advanceDialog);

        // keep following enemy
        const follow = setInterval(() => {
          if (!document.body.contains(enemy)) {
            bubble.remove();
            clearInterval(follow);
            document.removeEventListener("click", advanceDialog);
          } else {
            update();
          }
        }, 30);
      }
    </script>
  </body>
</html>
